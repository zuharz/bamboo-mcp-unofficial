#!/bin/sh
# Pre-commit hook for BambooHR MCP Server
# Industry best practices: DXT validation, linting, formatting, and type checking

echo "ğŸ” Running pre-commit quality checks..."

# Check if git has staged files
STAGED_FILES=$(git diff --cached --name-only)
if [ -z "$STAGED_FILES" ]; then
    echo "ğŸ“ No staged files found"
    exit 0
fi

# Performance optimization: use lint-staged for changed files only
echo "ğŸš€ Running lint-staged on changed files..."
if command -v npx &> /dev/null && [ -f "node_modules/.bin/lint-staged" ]; then
    npx lint-staged
    if [ $? -ne 0 ]; then
        echo "âŒ Linting/formatting failed. Please fix issues and try again."
        echo "ğŸ’¡ Tip: Run 'npm run lint:fix' to auto-fix some issues"
        exit 1
    fi
    echo "âœ… Code quality checks passed"
else
    # Fallback: basic linting if lint-staged unavailable
    echo "âš ï¸  lint-staged not available, running basic checks..."
    
    # Check TypeScript files
    TS_FILES=$(echo "$STAGED_FILES" | grep '\.ts$' || true)
    if [ ! -z "$TS_FILES" ]; then
        echo "ğŸ”§ Checking TypeScript files..."
        npm run lint:src
        if [ $? -ne 0 ]; then
            echo "âŒ TypeScript linting failed"
            exit 1
        fi
    fi
    
    # Check JavaScript files  
    JS_FILES=$(echo "$STAGED_FILES" | grep '\.js$' || true)
    if [ ! -z "$JS_FILES" ]; then
        echo "ğŸ” Checking JavaScript files..."
        npm run lint:server
        if [ $? -ne 0 ]; then
            echo "âŒ JavaScript linting failed"
            exit 1
        fi
    fi
fi

# TypeScript type checking
echo "ğŸ”§ Running TypeScript type check..."
npm run typecheck
if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type check failed. Please fix type errors."
    exit 1
fi

# DXT validation (essential for MCP server)
echo "ğŸ“‹ Validating DXT manifest..."
if command -v dxt &> /dev/null; then
    dxt validate manifest.json
    if [ $? -ne 0 ]; then
        echo "âŒ DXT manifest validation failed. Please fix manifest.json."
        exit 1
    fi
else
    echo "âš ï¸  DXT CLI not found. Installing globally..."
    npm install -g @anthropic-ai/dxt
    if command -v dxt &> /dev/null; then
        dxt validate manifest.json
        if [ $? -ne 0 ]; then
            echo "âŒ DXT manifest validation failed"
            exit 1
        fi
    else
        echo "âŒ Failed to install DXT CLI"
        exit 1
    fi
fi

# Build validation (ensure code compiles)
echo "ğŸ—ï¸  Running build validation..."
./scripts/build.sh
if [ $? -ne 0 ]; then
    echo "âŒ Build failed. Please fix build errors before committing."
    exit 1
fi

# Verify essential files exist
if [ ! -f "server/index.js" ]; then
    echo "âŒ Missing server/index.js - build may have failed"
    exit 1
fi

echo "âœ… All pre-commit quality checks passed!"
echo "ğŸ“‹ Summary: Linting âœ“ | Formatting âœ“ | Types âœ“ | DXT âœ“ | Build âœ“"
exit 0