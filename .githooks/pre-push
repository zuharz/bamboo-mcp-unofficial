#!/bin/sh
# Pre-push hook for BambooHR MCP Server  
# Industry best practices: Full quality validation before push

echo "ğŸš€ Running comprehensive pre-push validation..."

# Check if npm is available
if ! command -v npm &> /dev/null; then
    echo "âŒ npm is not installed or not in PATH"
    exit 1
fi

# Auto-fix common issues before validation
echo "ğŸ”§ Auto-fixing common code quality issues..."

# Step 1: Auto-fix linting issues
echo "   ğŸ”§ Running lint auto-fix..."
npm run lint:fix
LINT_FIX_EXIT_CODE=$?
if [ $LINT_FIX_EXIT_CODE -eq 0 ]; then
    echo "   âœ… Linting auto-fixes applied successfully"
else
    echo "   âš ï¸  Some linting issues detected (exit code: $LINT_FIX_EXIT_CODE)"
fi

# Step 2: Auto-format code
echo "   ğŸ¨ Auto-formatting code..."
npm run format
FORMAT_EXIT_CODE=$?
if [ $FORMAT_EXIT_CODE -eq 0 ]; then
    echo "   âœ… Code formatting applied successfully"
else
    echo "   âš ï¸  Code formatting encountered issues (exit code: $FORMAT_EXIT_CODE)"
fi

# Step 3: Stage any auto-fixes that were applied
echo "   ğŸ“‹ Staging any auto-fixes..."
git add -A
echo "   âœ… Auto-fixes staged for commit"

# Final quality validation after auto-fixes
echo "ğŸ” Running complete quality validation after auto-fixes..."
npm run quality
QUALITY_EXIT_CODE=$?
if [ $QUALITY_EXIT_CODE -ne 0 ]; then
    echo "âŒ Quality checks still failing after auto-fixes (exit code: $QUALITY_EXIT_CODE)"
    echo "ğŸ’¡ Manual intervention required - some issues cannot be auto-fixed"
    echo "ğŸ” Review the output above and fix remaining issues manually"
    exit 1
fi
echo "âœ… Code quality validation passed"

# Run test suite
echo "ğŸ§ª Running test suite..."
npm test
TEST_EXIT_CODE=$?
if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "âš ï¸  Tests failed or are misconfigured (exit code: $TEST_EXIT_CODE)"
    echo "ğŸ’¡ Tip: Run 'npm test' locally to debug the issues"
    echo "ğŸ“ Continuing with other checks for now..."
    # Don't exit - tests might be work in progress
fi

# Build validation
echo "ğŸ—ï¸ Running complete build validation..."
npm run build
if [ $? -ne 0 ]; then
    echo "âŒ Build failed. Please fix the build errors before pushing."
    exit 1
fi
echo "âœ… Build validation passed"

# MCP Protocol Version Validation  
echo "ğŸ” Validating MCP protocol compatibility..."

# Check MCP SDK version
REQUIRED_MCP_VERSION="1.17.0"
CURRENT_MCP_VERSION=$(node -p "require('./package.json').dependencies['@modelcontextprotocol/sdk'].replace(/[\^~]/, '')" 2>/dev/null || echo "unknown")

if [ "$CURRENT_MCP_VERSION" = "unknown" ]; then
    echo "âŒ Could not detect MCP SDK version"
    echo "ğŸš« PUSH BLOCKED - Ensure @modelcontextprotocol/sdk is properly installed"
    exit 1
fi

echo "   Current MCP SDK: $CURRENT_MCP_VERSION"
echo "   Required MCP SDK: $REQUIRED_MCP_VERSION+"

# Version comparison
if [ "$(printf '%s\n' "$REQUIRED_MCP_VERSION" "$CURRENT_MCP_VERSION" | sort -V | head -n1)" = "$REQUIRED_MCP_VERSION" ]; then
    echo "âœ… MCP SDK supports latest protocol (2025-06-18)"
else
    echo "âŒ MCP SDK version too old for latest protocol (2025-06-18)"
    echo "ğŸš« PUSH BLOCKED - Update with: npm install @modelcontextprotocol/sdk@latest"
    exit 1
fi

# Check for hardcoded old protocol versions
echo "ğŸ” Scanning for outdated protocol version references..."
if grep -r "2024-11-05\|2024-10-07\|2024-09-25" src/ --include="*.ts" --include="*.js" 2>/dev/null; then
    echo "âŒ Found outdated protocol version references"
    echo "ğŸš« PUSH BLOCKED - Remove hardcoded protocol versions, let SDK handle negotiation"
    exit 1
fi
echo "âœ… No outdated protocol version references found"

# DXT packaging validation (STRICT MODE)
echo "ğŸ“¦ Running comprehensive DXT package validation..."

# Ensure DXT CLI is available
if ! command -v dxt &> /dev/null; then
    echo "ğŸ“¥ Installing DXT CLI for validation..."
    npm install -g @anthropic-ai/dxt
    if ! command -v dxt &> /dev/null; then
        echo "âŒ Failed to install DXT CLI - cannot proceed"
        echo "ğŸ’¡ Please install manually: npm install -g @anthropic-ai/dxt"
        exit 1
    fi
    echo "âœ… DXT CLI installed successfully"
fi

# Strict DXT validation with full output capture
echo "ğŸ” Running strict DXT validation..."
DXT_OUTPUT=$(dxt validate manifest.json 2>&1)
DXT_EXIT_CODE=$?

echo "ğŸ“‹ DXT Validation Output:"
echo "$DXT_OUTPUT"

# Check for any errors or warnings
if [ $DXT_EXIT_CODE -ne 0 ]; then
    echo "âŒ DXT validation failed with errors"
    echo "ğŸš« PUSH BLOCKED - Fix DXT validation errors before pushing"
    exit 1
fi

# Check for actual DXT warnings/errors (be more specific)
if echo "$DXT_OUTPUT" | grep -E "(ERROR|WARNING|WARN|Failed|Invalid|Error):"; then
    echo "âš ï¸  DXT validation contains warnings or errors"
    echo "ğŸš« PUSH BLOCKED - All DXT warnings must be resolved"
    echo ""
    echo "ğŸ’¡ Common fixes:"
    echo "   - Check manifest.json for syntax errors"
    echo "   - Ensure all required fields are present"
    echo "   - Verify file paths in manifest"
    exit 1
fi

# Check essential DXT files
MISSING_FILES=""
if [ ! -f "manifest.json" ]; then
    MISSING_FILES="$MISSING_FILES manifest.json"
fi
if [ ! -f "server/index.js" ]; then
    MISSING_FILES="$MISSING_FILES server/index.js"
fi
if [ ! -f ".dxtignore" ]; then
    echo "âš ï¸  Warning: .dxtignore not found - package may be larger than optimal"
fi

if [ ! -z "$MISSING_FILES" ]; then
    echo "âŒ Missing essential DXT files:$MISSING_FILES"
    exit 1
fi

# Comprehensive DXT package creation test
echo "ğŸ“‹ Testing actual DXT package creation..."
TEMP_DXT_DIR=$(mktemp -d)
cd "$TEMP_DXT_DIR"
cp -r "$OLDPWD"/* . 2>/dev/null || true
cp -r "$OLDPWD"/.dxtignore . 2>/dev/null || true

DXT_PACK_OUTPUT=$(dxt pack 2>&1)
DXT_PACK_EXIT_CODE=$?

echo "ğŸ“‹ DXT Pack Output:"
echo "$DXT_PACK_OUTPUT"

if [ $DXT_PACK_EXIT_CODE -ne 0 ]; then
    echo "âŒ DXT package creation failed"
    echo "ğŸš« PUSH BLOCKED - Cannot create valid DXT package"
    cd "$OLDPWD"
    rm -rf "$TEMP_DXT_DIR"
    exit 1
fi

# Check for actual DXT packaging warnings/errors
if echo "$DXT_PACK_OUTPUT" | grep -E "(ERROR|WARNING|WARN|Failed|Invalid|Error):"; then
    echo "âš ï¸  DXT package creation contains warnings"
    echo "ğŸš« PUSH BLOCKED - Resolve all DXT packaging warnings"
    cd "$OLDPWD"
    rm -rf "$TEMP_DXT_DIR"
    exit 1
fi

# Verify DXT file was created
DXT_FILE=$(find . -name "*.dxt" | head -1)
if [ -z "$DXT_FILE" ]; then
    echo "âŒ No DXT file was created"
    echo "ğŸš« PUSH BLOCKED - DXT packaging failed silently"
    cd "$OLDPWD"
    rm -rf "$TEMP_DXT_DIR"
    exit 1
fi

# Verify DXT file size is reasonable (not empty, not too large)
DXT_SIZE=$(stat -f%z "$DXT_FILE" 2>/dev/null || stat -c%s "$DXT_FILE" 2>/dev/null)
if [ "$DXT_SIZE" -lt 1000 ]; then
    echo "âŒ DXT file is suspiciously small ($DXT_SIZE bytes)"
    echo "ğŸš« PUSH BLOCKED - DXT package appears incomplete"
    cd "$OLDPWD"
    rm -rf "$TEMP_DXT_DIR"
    exit 1
fi

echo "âœ… DXT package created successfully ($DXT_SIZE bytes)"
cd "$OLDPWD"
rm -rf "$TEMP_DXT_DIR"

echo "âœ… All DXT validations passed"

# Security check - ensure no secrets in staged files
echo "ğŸ”’ Running security check..."
STAGED_FILES=$(git diff --cached --name-only)
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for common secret patterns
        if grep -qE "(api[_-]?key|password|secret|token).*[=:].*['\"][^'\"]{8,}" "$file" 2>/dev/null; then
            echo "âš ï¸  Potential secret detected in $file - please review"
            echo "ğŸ’¡ Use environment variables for sensitive data"
        fi
    fi
done
echo "âœ… Security check completed"

# Final summary
echo ""
echo "ğŸ‰ All pre-push validations passed!"
echo "ğŸ“‹ Summary:"
echo "  âœ… Code Quality (lint, format, types)"
echo "  âœ… Build Validation"  
echo "  âœ… MCP Protocol Validation (2025-06-18)"
echo "  âœ… DXT Manifest Validation (STRICT MODE)"
echo "  âœ… DXT Package Creation (VERIFIED)"
echo "  âœ… Security Check"
echo "  ğŸ“ Tests: $([ $TEST_EXIT_CODE -eq 0 ] && echo "âœ… Passed" || echo "âš ï¸  Needs attention")"
echo ""
echo "ğŸš€ Ready to push with guaranteed DXT quality!"
exit 0